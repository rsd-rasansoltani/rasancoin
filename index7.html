<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª â€” Ú©Ø¯ Ù¾ÙˆÛŒØ§ (ÙÙ‚Ø· Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡)</title>
  <style>
    :root{ --bg:#ffffff; --card:#f7fff7; --accent:#1e7d32; --muted:#5a5a5a }
    *{box-sizing:border-box;font-family:Tahoma, Arial, 'IRANSans', system-ui}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#f0fff4 0,#ffffff 100%);display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:100%;max-width:680px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    h1{margin:0;color:var(--accent);font-size:20px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,80,0,0.06)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,128,0,0.12);background:transparent;color:inherit}
    .row{display:flex;gap:8px}
    .btn{cursor:pointer;padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#4caf50);color:#fff;font-weight:700}
    .ghost{background:transparent;border:1px solid rgba(0,128,0,0.18);color:var(--accent)}
    .code{font-family:monospace;background:#fff;padding:8px 10px;border-radius:8px;border:1px dashed rgba(0,0,0,0.06);user-select:text;}
    .panel{background:#ffffff;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);}
    footer{margin-top:12px;color:var(--muted);font-size:13px}
    .success{background:#e6f9ec;border:1px solid #b2dfbc;padding:10px;border-radius:8px;color:#1e7d32}
    .danger{background:#ffefef;border:1px solid #f5c6cb;padding:10px;border-radius:8px;color:#a94442}
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Ú©Ø§Ø±Øªâ€ŒØ¨Ù‡â€ŒÚ©Ø§Ø±Øª â€” Ù…Ù‡Ø± Ù¾Ø§ÛŒ (10.10.202)</h1>
      <div class="small muted">ÙˆØ±ÙˆØ¯ÛŒ: Ú†Øªâ€ŒØ¢ÛŒØ¯ÛŒ ÙØ±Ø³ØªÙ†Ø¯Ù‡ØŒ Ù…Ø¨Ù„ØºØŒ Ú†Øªâ€ŒØ¢ÛŒØ¯ÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ â€” Ø³Ù¾Ø³ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¢Ù† ÙÙ‚Ø· Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡</div>
    </header>

    <div class="card">
      <section>
        <h2>Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø¯ Ù¾ÙˆÛŒØ§</h2>
        <div style="margin-top:12px">
          <label>Chat ID ÙØ±Ø³ØªÙ†Ø¯Ù‡</label>
          <input id="srcChat" placeholder="Ù…Ø«Ø§Ù„: 123456789" />
        </div>

        <div style="margin-top:12px">
          <label>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
          <input id="amount" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 150000" />
        </div>

        <div style="margin-top:12px">
          <label>Chat ID Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù¾ÛŒØ§Ù…)</label>
          <input id="targetChat" placeholder="Chat ID Ú¯ÛŒØ±Ù†Ø¯Ù‡ ÛŒØ§ " />
        </div>

        <div style="margin-top:12px" class="row">
          <button id="genCodeBtn" class="btn">Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ù¾ÙˆÛŒØ§</button>
          <button id="clearBtn" class="ghost">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
        </div>
        
        <hr style="margin:12px 0" />

        <h3>ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ùˆ ØªØ§ÛŒÛŒØ¯</h3>
        <div style="margin-top:8px">
          <label>Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†</label>
          <input id="pasteCode" placeholder="Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ø±Ù‚Ù…ÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú†Ø³Ø¨Ø§Ù†" />
        </div>
        <div style="margin-top:8px" class="row">
          <button id="verifyBtn" class="btn">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø¯Ø§Ù…Ù‡</button>
          <button id="checkBtn" class="ghost">Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯</button>
        </div>

        <div id="resultArea" style="margin-top:12px"></div>

        <div style="margin-top:12px" class="danger">Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¬Ù‡Øª Ù…Ù‡Ø± Ø¨Ù‡ Ù…Ù‡Ø± Ú©Ø±Ø¯Ù† Ø§Ø³Øª</div>
      </section>

      <div style="margin-top:12px" class="panel">
        <div class="muted">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
        <div style="margin-top:8px" class="small">autoSend: <label><input id="autoSend" type="checkbox" checked /> Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡</label></div>
      </div>

      <div style="margin-top:12px" class="panel">
        <div class="muted">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</div>
        <ul class="small">
          <li>Û±) Ø¨Ø§ Ø²Ø¯Ù† Â«Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ù¾ÙˆÛŒØ§Â» Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ú©Ø¯ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ (Ø¯Ø± ØµÙˆØ±Øª ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù†) Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ù¾ÛŒØ§Ù… Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
          <li>Û²) Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ÛŒ Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø´Ø§Ù…Ù„: Ù…Ø¨Ù„ØºØŒ Ú†Øªâ€ŒØ¢ÛŒØ¯ÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ùˆ Ù†Ø§Ù… Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø¨ÙˆØ¯Ù†) Ùˆ Ú©Ø¯ Û²Û¶ Ø±Ù‚Ù…ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.</li>
          <li>Û³) Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø¯Ø®Ø§Ù„ØªÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¬Ø±ÛŒØ§Ù† Ù†Ø¯Ø§Ø±Ø¯ â€” ØªÙ…Ø§Ù… Ø±ÙˆÙ†Ø¯ ÙÙ‚Ø· Ø¨ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø³Ø§ÛŒØª/Ø±Ø¨Ø§Øª Ø´Ù…Ø§Ø³Øª.</li>
        </ul>
      </div>

    </div>

    <footer class="small muted">ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ø§ÛŒÙ† ÙˆØ¨â€ŒØ³Ø§ÛŒØª Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Screenloop Ø§Ø³Øª.</footer>
  </div>

<script>
/* Ø±Ù…Ø² ØªÙˆÚ©Ù† (Ù…Ø­Ø§ÙØ¸Øª Ø³Ø§Ø¯Ù‡ Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„) */
const XOR_KEY = 'rasan_key_42';
const ENCODED_TOKEN_XOR = 'RVdCUl1sUlJBbw5zMyQaWR8QIxI2FwxRCi1LCCxtDhRAbVBGGA46KBptICIWKA==';
function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
function xorString(str,key){ let out=''; for(let i=0;i<str.length;i++) out+=String.fromCharCode(str.charCodeAt(i)^key.charCodeAt(i%key.length)); return out }
function getBotToken(){ const step1 = base64Decode(ENCODED_TOKEN_XOR); if(!step1) return null; return xorString(step1,XOR_KEY); }

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
  authDomain: "rasancoin.firebaseapp.com",
  projectId: "rasancoin",
  storageBucket: "rasancoin.firebasestorage.app",
  messagingSenderId: "289625483659",
  appId: "1:289625483659:web:b7e170072cf09a7157678e",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
auth.signInAnonymously().catch(e=>console.warn('auth error',e));

/* ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ 26 Ø±Ù‚Ù…ÛŒ ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ */
function genNumericCode26(){ let s=''; for(let i=0;i<26;i++) s += Math.floor(Math.random()*10).toString(); return s }

/* ØªÙ„Ú¯Ø±Ø§Ù… */
async function getChatInfo(chatId){ const token = getBotToken(); if(!token) return null; try{ const res = await fetch(`https://api.telegram.org/bot${encodeURIComponent(token)}/getChat`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: chatId }) }); const j = await res.json(); if(j.ok) return j.result; return null; }catch(e){ console.warn('getChat error',e); return null; } }

async function sendTelegramMessageHidden(chatId, text){ const token = getBotToken(); if(!token) return { ok:false, error:'token decode failed' }; const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`; const body = { chat_id: chatId, text, parse_mode: 'HTML' }; try{ const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }); return await res.json(); }catch(err){ return { ok:false, error: err.message }; } }

/* Ø°Ø®ÛŒØ±Ù‡ Ú©Ø¯ Ø¯Ø± Firestore */
async function saveDynamicCode(doc){ try{ await db.collection('dynamic_codes').doc(doc.code).set(doc); return true; }catch(e){ console.warn('save error',e); return false } }

/* Ø¹Ù†Ø§ØµØ± UI */
const srcChat = document.getElementById('srcChat');
const amount = document.getElementById('amount');
const targetChat = document.getElementById('targetChat');
const genCodeBtn = document.getElementById('genCodeBtn');
const clearBtn = document.getElementById('clearBtn');
// const dynamicCodeEl = document.getElementById('dynamicCode'); // Ø­Ø°Ù Ø´Ø¯
const pasteCode = document.getElementById('pasteCode');
const verifyBtn = document.getElementById('verifyBtn');
const checkBtn = document.getElementById('checkBtn');
const resultArea = document.getElementById('resultArea');

let currentDynamic = null;

/* ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ÙÙ‚Ø· Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡ */
genCodeBtn.addEventListener('click', async ()=>{
  try{
    const sc = srcChat.value.trim(); const amt = Number(amount.value) || 0; const tgt = targetChat.value.trim();
    if(!sc) return alert('Chat ID ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
    if(amt<=0) return alert('Ù…Ø¨Ù„Øº Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†');
    if(!tgt) return alert('Chat ID Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');

    const code = genNumericCode26();
    // Ú¯Ø±ÙØªÙ† Ù†Ø§Ù… Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù¾ÛŒØ§Ù…)
    const tgtInfo = await getChatInfo(tgt);
    const tgtName = tgtInfo ? (tgtInfo.first_name || tgtInfo.username || 'Ú©Ø§Ø±Ø¨Ø±') : 'Ú©Ø§Ø±Ø¨Ø±';

    const doc = { code, src: sc, target: tgt, targetName: tgtName, amount: amt, status: 'pending', createdAt: Date.now() };
    const saved = await saveDynamicCode(doc);
    if(!saved) return alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø¯ Ø±ÙˆÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³');

    currentDynamic = doc;
    // dynamicCodeEl.textContent = code; // Ø­Ø°Ù Ø´Ø¯

    const numericOnly = code.replace(/[^0-9]/g,'');
    const message = `ğŸ’¸ Ø§Ø±Ø³Ø§Ù„ Ù…Ø¨Ù„Øº ${amt.toLocaleString()} ØªÙˆÙ…Ø§Ù†\nØ¨Ù‡ Ú†Øª Ø¢ÛŒØ¯ÛŒ ${tgt}\nÚ©Ø§Ø±Ø¨Ø±: ${tgtName}\n\nğŸ” Ú©Ø¯ Ù¾ÙˆÛŒØ§: <code>${numericOnly}</code>\n(Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒØŒ Ø±ÙˆÛŒ Ú©Ø¯ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)`; // <code> Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯Ù† Ú©Ù¾ÛŒ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù…

    if(document.getElementById('autoSend').checked){
      const resp = await sendTelegramMessageHidden(sc, message);
      if(resp && resp.ok){ alert('Ú©Ø¯ Ù¾ÙˆÛŒØ§ Ø³Ø§Ø®ØªÙ‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯. Ú©Ø¯ Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.'); }
      else { console.warn(resp); alert('Ú©Ø¯ Ø³Ø§Ø®ØªÙ‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ØŒ Ø§Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯ â€” ØªÙˆÚ©Ù† ÛŒØ§ Chat ID Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†'); }
    } else {
      alert('Ú©Ø¯ Ø³Ø§Ø®ØªÙ‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª). Ú©Ø¯ Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø§Ù…Ø§ Ø¯Ø± Ø³Ø§ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Chat ID ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ùˆ Ù…Ø¨Ù„Øº Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø§Ùˆ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.');
    }
  }catch(e){ console.error(e); alert('Ø®Ø·Ø§: '+e); }
});

/* Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù… */
clearBtn.addEventListener('click', ()=>{ srcChat.value=''; amount.value=''; targetChat.value=''; currentDynamic=null; resultArea.innerHTML=''; }); // dynamicCodeEl.textContent='â€”'; Ø­Ø°Ù Ø´Ø¯

/* Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯ */
checkBtn.addEventListener('click', async ()=>{
  const code = (pasteCode.value||'').trim(); if(!code) return alert('Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
  try{
    const snap = await db.collection('dynamic_codes').doc(code).get(); if(!snap.exists) return alert('Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
    const doc = snap.data(); showDocPreview(doc);
  }catch(e){ console.error(e); alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ'); }
});

/* ØªØ§ÛŒÛŒØ¯ Ú©Ø¯ Ùˆ Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´ Ù†Ù‡Ø§ÛŒÛŒ */
verifyBtn.addEventListener('click', async ()=>{
  const code = (pasteCode.value||'').trim(); if(!code) return alert('Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
  try{
    const ref = db.collection('dynamic_codes').doc(code);
    const snap = await ref.get(); if(!snap.exists) return alert('Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
    const doc = snap.data(); if(doc.status !== 'pending') return alert('Ú©Ø¯ Ù‚Ø¨Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
    await ref.update({ status: 'confirmed', confirmedAt: Date.now() });
    showTransactionResult(doc);
  }catch(e){ console.error(e); alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯'); }
});

function showDocPreview(doc){ resultArea.innerHTML = `<div class="panel"><div><b>Ú©Ø¯:</b> ${doc.code}</div><div><b>ÙØ±Ø³ØªÙ†Ø¯Ù‡:</b> ${doc.src}</div><div><b>Ú¯ÛŒØ±Ù†Ø¯Ù‡:</b> ${doc.target} (${doc.targetName||''})</div><div><b>Ù…Ø¨Ù„Øº:</b> ${doc.amount.toLocaleString()}</div><div><b>ÙˆØ¶Ø¹ÛŒØª:</b> ${doc.status}</div></div>`; }

function showTransactionResult(doc){ resultArea.innerHTML = `<div class="success"><b>ØªØ±Ø§Ú©Ù†Ø´ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯</b><div>ÙØ±Ø³ØªÙ†Ø¯Ù‡: ${doc.src}</div><div>Ú¯ÛŒØ±Ù†Ø¯Ù‡: ${doc.target} (${doc.targetName||''})</div><div><b>Ù…Ø¨Ù„Øº:</b> ${doc.amount.toLocaleString()}</div><div>Ú©Ø¯: ${doc.code}</div></div>`; }

// init
(async function(){ try{ const last = localStorage.getItem('kart_src'); if(last) srcChat.value = last; srcChat.addEventListener('change', ()=> localStorage.setItem('kart_src', srcChat.value.trim())); }catch(e){} })();

</script>
</body>
</html>
