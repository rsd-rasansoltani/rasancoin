<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NatCoin — توکن پنهان و خروجی رمزی</title>
  <style>
    :root{--bg:#071024;--card:#0f1724;--accent:#06b6d4;--muted:#9ca3af;color-scheme:dark}
    *{box-sizing:border-box;font-family:Vazirmatn,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071021 0%,#081226 100%);color:#e6eef6;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:980px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,.6)}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,button,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .muted{color:var(--muted);font-size:13px}
    .right{display:flex;flex-direction:column;gap:12px}
    .balance{font-size:34px;font-weight:700}
    .small{font-size:13px}
    .row{display:flex;gap:10px}
    .btn{cursor:pointer;padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#7c3aed);color:#021024;font-weight:700}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    footer{margin-top:12px;color:var(--muted);font-size:13px}
    .notice{background:#0b2230;padding:10px;border-radius:8px;color:#bfeaf6}
    .danger{background:#2b0b0b;color:#ffcccb;padding:10px;border-radius:8px}
    @media(max-width:880px){.grid{grid-template-columns:1fr;}.right{order:-1}}
  </style>

  <!-- Firebase compat scripts (بدون module) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <!-- اگر می‌خواهی Analytics، uncomment کن:
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  -->
</head>
<body>
  <div class="wrap">
    <header>
      <h1>RASAN COIN — RSD64 &amp; خروجی رمزی</h1>
      <div class="muted">    راسان‌کوین یک توکن نوآورانه و امن است که با هدف ایجاد بستری سودآور و شفاف برای کاربران طراحی شده.
    در این سیستم می‌توانید دارایی دیجیتال خود را نگهداری، مبادله و حتی از سود دوره‌ای بهره‌مند شوید.</div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>ورود / ثبت‌نام (امنیت: پایه — RSD64)</h2>
        <p class="muted"> راسان‌کوین ترکیبی از نوآوری و اعتماد است. این توکن برای سرمایه‌گذاری بلندمدت و انجام تراکنش‌های سریع و امن طراحی شده.
      تیم توسعه با بهره‌گیری از فناوری‌های پیشرفته بلاک‌چین، تجربه‌ای متفاوت و مدرن را برای کاربران فراهم کرده است.</p>

        <div style="margin-top:12px">
          <label>Chat ID که ربات پس از استارت کردن به شما میدهد</label>
          <input id="chatIdInput" placeholder="Chat ID که ربات پس از استارت کردن به شما میدهد" />
        </div>

        <div style="margin-top:10px" class="row">
          <button id="startBtn" class="btn">دریافت کد (تلگرام)</button>
          <button id="loginBtn" class="ghost">اعتبارسنجی کد</button>
        </div>

        <div style="margin-top:12px">
          <label>کدی که دریافت کردید</label>
          <input id="codeInput" placeholder="کد 5 رقمی" />
        </div>

        <div style="margin-top:12px">
          <label>مقدار انتقال (سکه)</label>
          <input id="transferAmount" type="number" min="0" step="1" placeholder="مثال: 1000 — مقداری که می‌خواهی صادر/انتقال بدی" />
        </div>

        <div style="margin-top:12px">
          <label>خروجی حساب (رمزی)</label>
          <div class="row">
            <button id="exportBase64" class="ghost">خروجی RSD64 (کسر می‌شود)</button>
            <button id="exportEncrypted" class="ghost">خروجی رمز شده (رمز وارد کن)</button>
          </div>
          <textarea id="exportArea" style="margin-top:8px;height:84px;" placeholder="اینجا خروجی ظاهر می‌شود"></textarea>
        </div>

        <div style="margin-top:12px">
          <label>درون‌ریزی (RSD64 یا رمز شده)</label>
          <textarea id="importArea" style="height:88px;" placeholder="اینجا Base64 یا متن رمز شده را بچسبان و سپس دکمهٔ مناسب را بزن"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="importBase64" class="ghost">درون‌ریزی Rsd64</button>
            <button id="importEncrypted" class="ghost">درون‌ریزی رمز شده (رمز لازم)</button>
          </div>
        </div>

        <div style="margin-top:12px" class="danger">
          هشدار: این برنامه امنیت فراوانی دارد پس اصلا  نگران توکن ها و موجودی خود  نباشید.
        </div>

      </section>

      <aside class="card right">
        <div>
          <div class="muted">حساب فعلی</div>
          <div id="accountBox">
            <div class="balance">—</div>
            <div class="muted small">آخرین بروزرسانی: —</div>
            <div style="margin-top:10px" class="row">
              <button id="collectBtn" class="btn">بروزرسانی موجودی</button>
              <button id="logoutBtn" class="ghost">خروج</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">تنظیمات</div>
          <div style="margin-top:8px" class="small">نرخ: <strong>10 سکه / ساعت</strong></div>
          <div class="small">save : <strong>   4ba.ir</strong></div>
          <div style="margin-top:8px"><label><input id="autoSend" type="checkbox" checked /> ارسال پیام با ربات</label></div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">راهنما کوتاه</div>
          <ul class="small">
            <li>۱) Chat ID را وارد کن و «دریافت کد» را بزن.</li>
            <li>۲) پیام حاوی کد به Chat ID ارسال می‌شود (در صورت فعال بودن ارسال).</li>
            <li>۳) کد را وارد کن و «اعتبارسنجی» را بزن تا وارد شوی.</li>
            <li>۴) برای خروجی امن، از گزینهٔ رمز شده استفاده کن و یک رمز قوی وارد کن.</li>
            <li>۵) هنگام خروجی مقدار انتقال را وارد کن — آن مقدار از حساب فرستنده کم می‌شود و هنگام درون‌ریزی به حساب مقصد اضافه می‌شود.</li>
          </ul>
        </div>

      </aside>
    </div>

    <footer class="muted">تمامی حقوق این وب سایت مربوط به شرکت راسان دیزاین است و تکثیر از ان به هر صورت پیگرد قانونی خواهد داشت.</footer>
  </div>

<script>
/* ------------------ پنهان‌سازی توکن (همان‌طور که بود) ------------------ */
const XOR_KEY = 'rasan_key_42';
const ENCODED_TOKEN_XOR = 'SlJHVFlqXlJLZw5zMyY6ViMoWzYhKHkKAyYDNSQXNC4tCHxfEFNeNTwqAiwsCg==';

function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
function base64Encode(s){ try{ return btoa(s); }catch(e){ return null; } }

function xorString(str, key){
  let out = '';
  for(let i=0;i<str.length;i++){ out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); }
  return out;
}

function getBotToken(){
  const step1 = base64Decode(ENCODED_TOKEN_XOR);
  if(!step1) return null;
  const token = xorString(step1, XOR_KEY);
  return token;
}

/* ------------------ تنظیم Firebase (جایگزین کن با config پروژه تو اگر فرق داره) ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
  authDomain: "rasancoin.firebaseapp.com",
  projectId: "rasancoin",
  storageBucket: "rasancoin.firebasestorage.app",
  messagingSenderId: "289625483659",
  appId: "1:289625483659:web:b7e170072cf09a7157678e",
  measurementId: "G-KNNM4FF9MS"
};

firebase.initializeApp(firebaseConfig);
// اگر analytics خواستی: firebase.analytics();

const db = firebase.firestore();
const auth = firebase.auth();

// احراز هویت ناشناس برای دسترسی به Firestore (برای dev)
auth.signInAnonymously().catch(e => console.warn('auth error', e));

/* ------------------ منطق NatCoin با Firestore ------------------ */
const RATE_PER_HOUR = 10;

async function loadUsers(){ // بازگشت یک object شبیه نسخه قبلی { chatId: {...}, ... }
  const snap = await db.collection('users').get();
  const out = {};
  snap.forEach(doc => { out[doc.id] = doc.data(); });
  return out;
}
async function saveUsers(users){
  // با batch هر سند را set می‌کنیم (overwrite برای هر سند موجود/جدید)
  const batch = db.batch();
  for(const k in users){
    const docRef = db.collection('users').doc(k);
    batch.set(docRef, users[k], { merge: true });
  }
  await batch.commit();
}

async function loadCodes(){
  const snap = await db.collection('codes').get();
  const out = {};
  snap.forEach(doc => { out[doc.id] = doc.data(); });
  return out;
}
async function saveCodes(codes){
  const batch = db.batch();
  for(const k in codes){
    const docRef = db.collection('codes').doc(k);
    batch.set(docRef, codes[k], { merge: true });
  }
  await batch.commit();
}

// helper‌های ظریف برای سند-به-سند
async function getUser(chatId){
  const doc = await db.collection('users').doc(chatId).get();
  return doc.exists ? doc.data() : null;
}
async function setUser(chatId, userObj){
  await db.collection('users').doc(chatId).set(userObj, { merge: true });
}
async function deleteUser(chatId){
  await db.collection('users').doc(chatId).delete();
}

async function getCode(chatId){
  const doc = await db.collection('codes').doc(chatId).get();
  return doc.exists ? doc.data() : null;
}
async function setCode(chatId, codeObj){
  await db.collection('codes').doc(chatId).set(codeObj);
}
async function deleteCode(chatId){
  await db.collection('codes').doc(chatId).delete();
}

/* ------------------ منطق حسابداری ------------------ */
function genCode(){ return Math.floor(10000 + Math.random()*90000).toString() }
function formatDate(ts){ if(!ts) return '—'; const d = new Date(ts); return d.toLocaleString(); }
function accrueFor(user){
  const now = Date.now();
  if(!user.lastUpdated){ user.lastUpdated = now; return; }
  const elapsed = now - user.lastUpdated;
  const coins = elapsed / 3600000 * RATE_PER_HOUR;
  user.balance = (user.balance||0) + coins;
  user.lastUpdated = now;
}

/* ------------------ رابط کاربری و توابع اصلی (تماماً async شد) ------------------ */
const chatIdInput = document.getElementById('chatIdInput');
const codeInput = document.getElementById('codeInput');
const startBtn = document.getElementById('startBtn');
const loginBtn = document.getElementById('loginBtn');
const collectBtn = document.getElementById('collectBtn');
const logoutBtn = document.getElementById('logoutBtn');
const exportBase64Btn = document.getElementById('exportBase64');
const exportEncryptedBtn = document.getElementById('exportEncrypted');
const exportArea = document.getElementById('exportArea');
const importArea = document.getElementById('importArea');
const importBase64Btn = document.getElementById('importBase64');
const importEncryptedBtn = document.getElementById('importEncrypted');
const transferAmountInput = document.getElementById('transferAmount');

let currentChatId = null;

async function renderAccount(chatId){
  const box = document.getElementById('accountBox');
  if(!chatId){ box.querySelector('.balance').textContent = '—'; box.querySelector('.muted.small').textContent = 'آخرین بروزرسانی: —'; return; }
  const u = await getUser(chatId);
  if(!u){ box.querySelector('.balance').textContent = '—'; box.querySelector('.muted.small').textContent = 'آخرین بروزرسانی: —'; return; }
  accrueFor(u);
  // ذخیره تغییرات به صورت خودکار
  await setUser(chatId, u);
  box.querySelector('.balance').textContent = Math.floor(u.balance).toLocaleString() + ' ⛁';
  box.querySelector('.muted.small').textContent = 'آخرین بروزرسانی: ' + formatDate(u.lastUpdated);
}

// ارسال پیام به تلگرام — توجه: توکن هنوز در کلاینت است (ناامن)
async function sendTelegramMessageHidden(chatId, text){
  const token = getBotToken();
  if(!token) return { ok:false, error:'token decode failed' };
  const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
  try{
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: chatId, text }) });
    const data = await res.json();
    return data;
  }catch(err){ return { ok:false, error:err.message } }
}

/* Export / Import (Base64 و رمز شده با WebCrypto) */ 
async function exportAccountBase64(chatId, transferAmount = 0){
  const u = await getUser(chatId);
  if(!u) throw 'no account';
  const amount = Number(transferAmount) || 0;
  if(amount < 0) throw 'bad amount';
  if(amount > 0){
    if((u.balance||0) < amount) throw 'insufficient balance';
    u.balance = (u.balance||0) - amount;
    u.lastUpdated = Date.now();
    await setUser(chatId, u);
  }
  const transfer = amount>0 ? { amount: amount, from: chatId, ts: Date.now(), id: (Date.now().toString(36) + Math.random().toString(36).slice(2,8)) } : null;
  const payload = { chatId, account: u, transfer };
  return base64Encode(JSON.stringify(payload));
}

async function exportAccountEncrypted(chatId, password, transferAmount = 0){
  const u = await getUser(chatId);
  if(!u) throw 'no account';
  const amount = Number(transferAmount) || 0;
  if(amount < 0) throw 'bad amount';
  if(amount > 0){
    if((u.balance||0) < amount) throw 'insufficient balance';
    u.balance = (u.balance||0) - amount;
    u.lastUpdated = Date.now();
    await setUser(chatId, u);
  }
  const transfer = amount>0 ? { amount: amount, from: chatId, ts: Date.now(), id: (Date.now().toString(36) + Math.random().toString(36).slice(2,8)) } : null;
  const plainObj = { chatId, account: u, transfer };
  const plain = JSON.stringify(plainObj);
  const enc = new TextEncoder().encode(plain);
  const pwKey = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const derived = await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:100000,hash:'SHA-256'}, pwKey, {name:'AES-GCM',length:256}, true, ['encrypt']);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const cipher = await crypto.subtle.encrypt({name:'AES-GCM',iv}, derived, enc);
  const combined = new Uint8Array(salt.byteLength + iv.byteLength + cipher.byteLength);
  combined.set(salt,0); combined.set(iv,salt.byteLength); combined.set(new Uint8Array(cipher), salt.byteLength + iv.byteLength);
  return base64Encode(String.fromCharCode.apply(null, combined));
}

async function importAccountEncrypted(blobBase64, password){
  const raw = base64Decode(blobBase64);
  if(!raw) throw 'bad base64';
  const bytes = Uint8Array.from(raw.split('').map(c=>c.charCodeAt(0)));
  const salt = bytes.slice(0,16); const iv = bytes.slice(16,28); const cipher = bytes.slice(28);
  const pwKey = await crypto.subtle.importKey('raw', new TextEncoder().encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
  const derived = await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:100000,hash:'SHA-256'}, pwKey, {name:'AES-GCM',length:256}, true, ['decrypt']);
  try{
    const plain = await crypto.subtle.decrypt({name:'AES-GCM',iv}, derived, cipher);
    const txt = new TextDecoder().decode(plain);
    const obj = JSON.parse(txt);
    // Save/restore source account
    await setUser(obj.chatId, obj.account);
    // If transfer exists, add to target
    if(obj.transfer && obj.transfer.amount){
      let target = currentChatId;
      if(!target || target === obj.chatId){
        target = prompt('برای کدام Chat ID می‌خواهید مبلغ را اضافه کنید؟ (Chat ID یا @username)', '');
        if(!target) return obj.chatId;
      }
      let tuser = await getUser(target);
      if(!tuser) tuser = { balance:0, lastUpdated: Date.now() };
      tuser.balance = (tuser.balance||0) + Number(obj.transfer.amount);
      tuser.lastUpdated = Date.now();
      await setUser(target, tuser);
      return target;
    }
    return obj.chatId;
  }catch(e){ throw 'decrypt failed'; }
}

async function importAccountBase64(blobBase64){
  const raw = base64Decode(blobBase64); if(!raw) throw 'bad base64';
  const obj = JSON.parse(raw);
  // Save source account state
  await setUser(obj.chatId, obj.account);
  // If transfer exists, add to target
  if(obj.transfer && obj.transfer.amount){
    let target = currentChatId;
    if(!target || target === obj.chatId){
      target = prompt('برای کدام Chat ID می‌خواهید مبلغ را اضافه کنید؟ (Chat ID یا @username)', '');
      if(!target) return obj.chatId;
    }
    let tuser = await getUser(target);
    if(!tuser) tuser = { balance:0, lastUpdated: Date.now() };
    tuser.balance = (tuser.balance||0) + Number(obj.transfer.amount);
    tuser.lastUpdated = Date.now();
    await setUser(target, tuser);
    return target;
  }
  return obj.chatId;
}

/* ------------------ UI bindings (event handlers) ------------------ */
startBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim(); if(!chatId) return alert('Chat ID را وارد کن');
  const code = genCode();
  await setCode(chatId, { code, created: Date.now() });
  if(document.getElementById('autoSend').checked){
    const text = `کد تایید شما: ${code}\n(NatCoin)`;
    const resp = await sendTelegramMessageHidden(chatId, text);
    if(resp && resp.ok) alert('کد ارسال شد'); else { console.error(resp); alert('ارسال موفق نبود — Chat ID یا توکن را بررسی کن (کنسول را ببین)'); }
  } else alert('کد ساخته شد (ارسال غیرفعال است)');
});

loginBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim(); const code = codeInput.value.trim(); if(!chatId||!code) return alert('Chat ID و کد لازم است');
  const e = await getCode(chatId); if(!e) return alert('ابتدا دریافت کد را بزن'); if(e.code !== code) return alert('کد نادرست');
  let u = await getUser(chatId);
  if(!u) u = { balance:0, lastUpdated: Date.now() };
  u.lastUpdated = u.lastUpdated || Date.now();
  await setUser(chatId, u);
  await deleteCode(chatId);
  currentChatId = chatId; localStorage.setItem('natcoin_last_chat', chatId); alert('ورود موفق'); await renderAccount(currentChatId);
});

collectBtn.addEventListener('click', async ()=>{ if(!currentChatId) return alert('ابتدا وارد شو'); let u = await getUser(currentChatId); if(!u) return alert('حساب یافت نشد'); accrueFor(u); await setUser(currentChatId, u); await renderAccount(currentChatId); });
logoutBtn.addEventListener('click', ()=>{ currentChatId = null; renderAccount(null); alert('خروج انجام شد'); });

exportBase64Btn.addEventListener('click', async ()=>{
  try{
    const chatId = chatIdInput.value.trim(); if(!chatId) return alert('Chat ID را وارد کن');
    const amt = Number(transferAmountInput.value) || 0;
    const out = await exportAccountBase64(chatId, amt);
    exportArea.value = out; alert('Base64 ساخته شد — آن را ذخیره کن');
    await renderAccount(chatId);
  }catch(e){ alert('خطا: '+e); }
});

exportEncryptedBtn.addEventListener('click', async ()=>{
  try{
    const chatId = chatIdInput.value.trim(); if(!chatId) return alert('Chat ID را وارد کن');
    const pwd = prompt('رمز عبور برای رمزگذاری را وارد کن (قوی باشد)'); if(!pwd) return alert('رمز لازم است');
    const amt = Number(transferAmountInput.value) || 0;
    const out = await exportAccountEncrypted(chatId, pwd, amt);
    exportArea.value = out; alert('خروجی رمز شده ساخته شد — آن را ذخیره کن');
    await renderAccount(chatId);
  }catch(e){ alert('خطا: '+e); }
});

importBase64Btn.addEventListener('click', async ()=>{
  try{
    const txt = importArea.value.trim(); if(!txt) return alert('متن را بچسبان');
    const target = await importAccountBase64(txt);
    alert('درون‌ریزی انجام شد برای: '+target);
    await renderAccount(target);
  }catch(e){ alert('خطا: '+e); }
});

importEncryptedBtn.addEventListener('click', async ()=>{
  try{
    const txt = importArea.value.trim(); if(!txt) return alert('متن را بچسبان');
    const pwd = prompt('رمز عبور برای بازگشایی را وارد کن'); if(!pwd) return alert('رمز لازم است');
    const target = await importAccountEncrypted(txt, pwd);
    alert('درون‌ریزی انجام شد برای: '+target);
    await renderAccount(target);
  }catch(e){ alert('خطا در بازگشایی یا درون‌ریزی'); }
});

(async function init(){
  const last = localStorage.getItem('natcoin_last_chat'); if(last) chatIdInput.value = last;
  // اگر last وجود داشته باشد، سعی کن render کنی (آسینک)
  if(localStorage.getItem('natcoin_last_chat')) {
    currentChatId = localStorage.getItem('natcoin_last_chat');
    try{ await renderAccount(currentChatId); }catch(e){}
  } else {
    renderAccount(null);
  }
  chatIdInput.addEventListener('change', ()=> localStorage.setItem('natcoin_last_chat', chatIdInput.value.trim()));
  setInterval(async ()=>{ if(currentChatId) await renderAccount(currentChatId); },30000);
})();
</script>
</body>
</html>
