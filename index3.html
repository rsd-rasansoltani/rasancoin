<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Triple Dice Roller â€” RASAN (Firebase)</title>
<style>
  :root {
    --bg-1: #f8fafc;         /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø³ÙÛŒØ¯ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
    --bg-2: #e9fce9;         /* Ø³Ø¨Ø² Ø®ÛŒÙ„ÛŒ Ú©Ù…Ø±Ù†Ú¯ */
    --card: #ffffffcc;       /* Ú©Ø§Ø±Øª Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ Ø³ÙÛŒØ¯ */
    --accent: #22c55e;       /* Ø³Ø¨Ø² Ø§ØµÙ„ÛŒ */
    --accent-2: #4ade80;     /* Ø³Ø¨Ø² Ø±ÙˆØ´Ù†â€ŒØªØ± */
    --good: #16a34a;         /* Ø³Ø¨Ø² ØªØ£ÛŒÛŒØ¯ÛŒ */
    --bad: #dc2626;          /* Ù‚Ø±Ù…Ø² Ù‡Ø´Ø¯Ø§Ø± */
    --text: #0f172a;         /* Ù…ØªÙ† ØªÛŒØ±Ù‡ */
    --muted: #64748b;        /* Ù…ØªÙ† Ú©Ù…â€ŒØ±Ù†Ú¯ */
    --shadow: 0 10px 30px rgba(0, 0, 0, .12);
    --radius: 18px;
  }

  body {
    margin: 0;
    font-family: Vazirmatn, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    background: linear-gradient(160deg, var(--bg-1), var(--bg-2));
    min-height: 100vh;
    color: var(--text);
    display: grid;
    place-items: center;
    padding: 20px;
  }

  .container { width: min(100%, 1100px); }

  .card {
    background: linear-gradient(180deg, rgba(255, 255, 255, .8), rgba(255, 255, 255, .6));
    backdrop-filter: blur(14px);
    border-radius: var(--radius);
    padding: 18px;
    border: 1px solid rgba(34, 197, 94, .15);
    box-shadow: var(--shadow);
  }

  h1 { margin: 0 0 8px 0; font-size: 22px; color: var(--accent); }

  .flex { display: flex; gap: 16px; }
  .col { flex: 1; }

  .panel {
    padding: 14px;
    border-radius: 12px;
    background: linear-gradient(180deg, rgba(255, 255, 255, .9), rgba(255, 255, 255, .7));
    border: 1px solid rgba(34, 197, 94, .2);
  }

  label { display: block; color: var(--muted); font-size: 13px; margin-bottom: 6px; }

  input, button, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid rgba(34, 197, 94, .25);
    background: transparent;
    color: var(--text);
  }

  .muted { color: var(--muted); font-size: 13px; }

  .dice-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-bottom: 12px; }

  .die {
    aspect-ratio: 1;
    border-radius: 14px;
    background: linear-gradient(145deg, #ffffff, #e6fbe6);
    display: grid;
    place-items: center;
    font-weight: 800;
    font-size: 44px;
    color: var(--accent);
    box-shadow: inset 0 4px 12px rgba(0,0,0,.05);
  }

  .controls { display: flex; gap: 10px; margin-top: 8px; }

  button.primary {
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    color: #fff;
    border: 0;
    padding: 12px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: transform .15s ease;
  }
  button.primary:hover { transform: translateY(-2px); }

  button.ghost {
    background: transparent;
    border: 1px solid rgba(34, 197, 94, .3);
    color: var(--accent);
    cursor: pointer;
    padding: 10px;
    border-radius: 10px;
    transition: background .2s;
  }
  button.ghost:hover { background: rgba(34, 197, 94, .08); }

  .right { width: 320px; }

  .status {
    margin-top: 8px;
    padding: 10px;
    border-radius: 10px;
    background: rgba(34, 197, 94, .08);
    font-size: 14px;
    border: 1px solid rgba(34, 197, 94, .2);
    color: var(--accent);
  }

  .confetti { position: fixed; inset: 0; pointer-events: none; }

  @media (max-width:880px){
    .flex{flex-direction:column}
    .right{width:100%}
    .dice-row{grid-template-columns:repeat(3,1fr)}
  }
</style>

</head>
<body>
  <div class="container">
    <div class="card">
      <div class="flex">
        <div class="col panel" id="uiArea">
          <!-- Login screen appears here when not authenticated -->
          <div id="loginScreen">
            <h1>ÙˆØ±ÙˆØ¯ Ø¨Ø§ ØªÙ„Ú¯Ø±Ø§Ù… â€” Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯</h1>
            <div class="muted">Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Chat ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†. Ú©Ø¯ÛŒ Ø¨Ù‡ Ø¢Ù† Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù¾Ø³ Ø§Ø² ØªØ§ÛŒÛŒØ¯ØŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
            <div style="margin-top:12px">
              <label>Chat ID</label>
              <input id="chatIdInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: 123456789" />
            </div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="sendCodeBtn" class="primary">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ (ØªÙ„Ú¯Ø±Ø§Ù…)</button>
              <button id="checkCodeBtn" class="ghost">Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯</button>
            </div>
            <div style="margin-top:8px">
              <label>Ú©Ø¯ Ø¯Ø±ÛŒØ§ÙØªÛŒ</label>
              <input id="codeInput" placeholder="Ú©Ø¯ 5 Ø±Ù‚Ù…ÛŒ" />
            </div>
            <div class="muted" style="margin-top:8px">ØªÙˆØ¬Ù‡: Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø±Ø· Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒ <strong>10000</strong> Ø§Ø³Øª Ùˆ Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±Ø· Ø¨Ø§ÛŒØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒØ´ Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ.</div>
          </div>

          <!-- Game screen (hidden until login) -->
          <div id="gameScreen" style="display:none">
            <h1>Triple Dice Roller â€” Ø¨Ø§Ø²ÛŒ Ø´Ø±Ø·ÛŒ</h1>
            <div class="muted">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ø´Ø±Ø· Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†. Ù¾Ø³ Ø§Ø² Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø´Ø±Ø·ØŒ ØªØ§Ø³â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù†Ø¯Ø§Ø².</div>

            <div style="margin-top:12px" class="dice-row">
              <div class="die" id="die1"><span class="value">1</span></div>
              <div class="die" id="die2"><span class="value">1</span></div>
              <div class="die" id="die3"><span class="value">1</span></div>
            </div>

            <div style="margin-top:8px">
              <label>Ù…Ù‚Ø¯Ø§Ø± Ø´Ø±Ø· (Ø­Ø¯Ø§Ù‚Ù„ 10000)</label>
              <input id="betAmount" type="number" min="10000" value="10000" />
            </div>
            <div class="controls">
              <button id="placeBetBtn" class="primary">Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø´Ø±Ø·</button>
              <button id="rollBtn" class="ghost" disabled>ğŸ² Ø§Ù†Ø¯Ø§Ø®ØªÙ† ØªØ§Ø³</button>
              <button id="logoutBtn" class="ghost">Ø®Ø±ÙˆØ¬</button>
            </div>

            <div id="result" class="status">Ù†ØªÛŒØ¬Ù‡: Ù‡Ù†ÙˆØ² Ø´Ø±Ø·ÛŒ Ø¨Ø³ØªÙ‡ Ù†Ø´Ø¯Ù‡</div>

          </div>
        </div>

        <aside class="right panel">
          <div>
            <div class="muted">Ø­Ø³Ø§Ø¨ ÙØ¹Ù„ÛŒ</div>
            <div style="margin-top:10px;font-size:28px;font-weight:800" id="balance">â€” â›</div>
            <div class="muted" id="lastUpdate">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: â€”</div>
            <div style="margin-top:10px" class="controls">
              <button id="refreshBtn" class="primary">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</button>
              <button id="exportBtn" class="ghost">ØµØ¯ÙˆØ± ÛŒÚ©â€ŒØ¨Ø§Ø±Ù…ØµØ±Ù</button>
            </div>
            <div style="margin-top:12px" class="muted">Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§: <span id="currentChat">â€”</span></div>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,.04)" />

          <div class="muted">Ø±Ø§Ù‡Ù†Ù…Ø§</div>
          <ul class="muted" style="padding-left:18px; margin-top:8px">
            <li>Û±) Chat ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Â«Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯Â» Ø±Ø§ Ø¨Ø²Ù†.</li>
            <li>Û²) Ú©Ø¯ Ø±Ø§ Ø¯Ø± Ú©Ø§Ø¯Ø± ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Â«Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†.</li>
            <li>Û³) Ø´Ø±Ø· Ø±Ø§ Ø­Ø¯Ø§Ù‚Ù„ 10000 Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ Ùˆ Ø³Ù¾Ø³ ØªØ§Ø³ Ø±Ø§ Ø¨Ù†Ø¯Ø§Ø².</li>
            <li>Û´) Ø§Ú¯Ø± Ù…Ø¬Ù…ÙˆØ¹ ØªØ§Ø³â€ŒÙ‡Ø§ > 12 â†’ Ø´Ø±Ø· Ø´Ù…Ø§ Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯). Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø´Ø±Ø· Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
          </ul>

          <div style="margin-top:12px" class="muted">Ù‡Ø´Ø¯Ø§Ø± Ø§Ù…Ù†ÛŒØªÛŒ: Ø¨Ø¹Ø¯ Ø§Ø² Ø´Ø±Ø· Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø± Ù…Ø¨Ù„Øº Ø´Ø±Ø· Ù‚Ø§Ø¨Ù„Ø¨Ø±Ú¯Ø´Øª Ù†ÛŒØ³Øª.</div>
        </aside>
 
      </div>
    </div>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    /* ---------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ù†Ø´Ø§Ù†â€ŒØ¯Ù‡Ù†Ø¯Ù‡Ù” ØªÙˆÚ©Ù† Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ Ùˆ Ú©Ù„ÛŒØ¯ XOR) ---------- */
    const XOR_KEY = 'rasan_key_42';
    // Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ø§Ø² ØªÙˆÚ©Ù†ÛŒ Ú©Ù‡ ÙØ±Ø³ØªØ§Ø¯ÛŒ Ø¨Ø§ XOR Ùˆ base64 ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ â€” Ø¯Ø± Ú©Ø¯ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø³Ù¾Ø³ Ø¯Ø± runtime Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    const ENCODED_TOKEN_XOR = 'RVhEWVZnU1NNaA5zMyQ9CA0uBAM0JWFnGy5KU11uXDIjG25iNBtGNiI8WjQBKA==';

    function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
    function xorString(str, key){ let out=''; for(let i=0;i<str.length;i++){ out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); } return out; }
    function getBotToken(){ const step1 = base64Decode(ENCODED_TOKEN_XOR); if(!step1) return null; return xorString(step1, XOR_KEY); }

    async function sendTelegramMessage(chatId, text){
      const token = getBotToken();
      if(!token) { console.error('token decode failed'); return { ok:false, error:'token decode failed' } }
      const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
      try{
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ chat_id: chatId, text }) });
        const data = await res.json(); return data;
      }catch(err){ return { ok:false, error: err.message } }
    }

    /* ---------- Firebase config (Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø´Ù…Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡) ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
      authDomain: "rasancoin.firebaseapp.com",
      projectId: "rasancoin",
      storageBucket: "rasancoin.firebasestorage.app",
      messagingSenderId: "289625483659",
      appId: "1:289625483659:web:b7e170072cf09a7157678e",
      measurementId: "G-KNNM4FF9MS"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    auth.signInAnonymously().catch(e=>console.warn(e));

    /* ---------- Ú©Ù…Ú©â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ÛŒ ---------- */
    const MIN_BET = 10000;
    function genCode(){ return Math.floor(10000 + Math.random()*90000).toString() }
    function formatDate(ts){ if(!ts) return 'â€”'; return new Date(ts).toLocaleString(); }

    async function getUser(chatId){ const doc = await db.collection('users').doc(chatId).get(); return doc.exists ? doc.data() : null }
    async function setUser(chatId, userObj){ await db.collection('users').doc(chatId).set(userObj, { merge:true }) }

    async function ensureUser(chatId){ let u = await getUser(chatId); if(!u){ u = { balance:0, lastUpdated: Date.now() }; await setUser(chatId,u); } return u }

    async function accrueFor(user){ const now = Date.now(); if(!user.lastUpdated){ user.lastUpdated = now; return; } const elapsed = now - user.lastUpdated; const coins = elapsed / 3600000 * 10; // Ù‡Ù…Ø§Ù† Ù†Ø±Ø® 10/h
      user.balance = (user.balance||0) + coins; user.lastUpdated = now; }

    /* ---------- UI Ø¹Ù†Ø§ØµØ± ---------- */
    const chatIdInput = document.getElementById('chatIdInput');
    const codeInput = document.getElementById('codeInput');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const checkCodeBtn = document.getElementById('checkCodeBtn');
    const loginScreen = document.getElementById('loginScreen');
    const gameScreen = document.getElementById('gameScreen');
    const balanceEl = document.getElementById('balance');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const currentChatEl = document.getElementById('currentChat');
    const placeBetBtn = document.getElementById('placeBetBtn');
    const rollBtn = document.getElementById('rollBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const betAmountInput = document.getElementById('betAmount');
    const resultEl = document.getElementById('result');
    const exportBtn = document.getElementById('exportBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    const diceEls = [document.getElementById('die1'), document.getElementById('die2'), document.getElementById('die3')];

    let currentChatId = null;
    let pendingBet = null; // { amount }

    /* ---------- Ø§Ø±Ø³Ø§Ù„/Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ ---------- */
    sendCodeBtn.addEventListener('click', async ()=>{
      const chatId = chatIdInput.value.trim(); if(!chatId) return alert('Chat ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
      const code = genCode();
      await db.collection('codes').doc(chatId).set({ code, created: Date.now() });
      const text = `Ú©Ø¯ ÙˆØ±ÙˆØ¯ Ø´Ù…Ø§: ${code}\n(rasan coin)`;
      const resp = await sendTelegramMessage(chatId, text);
      if(resp && resp.ok) alert('Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…'); else alert('Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯ â€” Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Chat ID ØµØ­ÛŒØ­ Ø§Ø³Øª ÛŒØ§ ØªÙˆÚ©Ù† Ø¯Ø±Ø³Øª Ø§Ø³Øª');
    });

    checkCodeBtn.addEventListener('click', async ()=>{
      const chatId = chatIdInput.value.trim(); const code = codeInput.value.trim(); if(!chatId||!code) return alert('Chat ID Ùˆ Ú©Ø¯ Ù„Ø§Ø²Ù… Ø§Ø³Øª');
      const snap = await db.collection('codes').doc(chatId).get(); if(!snap.exists) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©Ø¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†');
      const e = snap.data(); if(e.code !== code) return alert('Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');

      // ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ â€” Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ/Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨
      let u = await getUser(chatId);
      if(!u) u = { balance:0, lastUpdated: Date.now() };
      await setUser(chatId, u);
      await db.collection('codes').doc(chatId).delete();
      currentChatId = chatId; localStorage.setItem('natcoin_last_chat', chatId);
      showGame(); await renderAccount();
      alert('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ â€” Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
    });

    /* ---------- Ø±Ù†Ø¯Ø± Ø­Ø³Ø§Ø¨ ---------- */
    async function renderAccount(){ if(!currentChatId){ balanceEl.textContent = 'â€” â›'; lastUpdateEl.textContent = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: â€”'; currentChatEl.textContent='â€”'; return; }
      let u = await getUser(currentChatId); if(!u) u = { balance:0, lastUpdated: Date.now() };
      await accrueFor(u); await setUser(currentChatId, u);
      balanceEl.textContent = Math.floor(u.balance).toLocaleString() + ' â›'; lastUpdateEl.textContent = 'Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + formatDate(u.lastUpdated); currentChatEl.textContent = currentChatId;
    }

    refreshBtn.addEventListener('click', async ()=>{ if(!currentChatId) return alert('ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡'); await renderAccount(); alert('Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯'); });

    logoutBtn.addEventListener('click', ()=>{ currentChatId=null; localStorage.removeItem('natcoin_last_chat'); showLogin(); renderAccount(); alert('Ø®Ø±ÙˆØ¬ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'); });

    /* ---------- Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ø´Ø±Ø· (Transaction Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†) ---------- */
    placeBetBtn.addEventListener('click', async ()=>{
      if(!currentChatId) return alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´Ùˆ');
      const amt = Math.floor(Number(betAmountInput.value) || 0);
      if(amt < MIN_BET) return alert('Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø±Ø· '+MIN_BET+' Ø§Ø³Øª');
      try{
        const userRef = db.collection('users').doc(currentChatId);
        await db.runTransaction(async (tx)=>{
          const doc = await tx.get(userRef);
          if(!doc.exists) throw 'Ø­Ø³Ø§Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯';
          const data = doc.data(); await accrueFor(data);
          if((data.balance||0) < amt) throw 'moneynot';
          data.balance = (data.balance||0) - amt; data.lastUpdated = Date.now();
          tx.update(userRef, { balance: data.balance, lastUpdated: data.lastUpdated });
        });
        pendingBet = { amount: amt };
        resultEl.textContent = 'Ø´Ø±Ø· Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯: ' + amt.toLocaleString() + ' â› â€” Ø­Ø§Ù„Ø§ ØªØ§Ø³ Ø±Ø§ Ø¨Ù†Ø¯Ø§Ø²';
        rollBtn.disabled = false; placeBetBtn.disabled = true; await renderAccount();
      }catch(err){ if(err==='moneynot') alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª'); else { console.error(err); alert('Ø®Ø·Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø«Ø¨Øª Ø´Ø±Ø·'); } }
    });

    /* ---------- Ø§Ù†Ø¯Ø§Ø®ØªÙ† ØªØ§Ø³ ---------- */
    function rand(){ return Math.floor(Math.random()*6)+1 }
    function animateDice(){ diceEls.forEach(d=>{ d.classList.remove('shaking'); void d.offsetWidth; d.classList.add('shaking'); }); }
    function makeConfetti(){ const conf = document.getElementById('confetti'); for(let i=0;i<40;i++){ const piece = document.createElement('i'); piece.style.left = Math.random()*100 + 'vw'; piece.style.top = '-10px'; piece.style.width = (6+Math.random()*10)+'px'; piece.style.height = (8+Math.random()*10)+'px'; piece.style.background = `hsl(${Math.floor(Math.random()*360)} 90% 60%)`; piece.style.position='absolute'; piece.style.opacity='0.95'; piece.style.transform=`rotate(${Math.random()*360}deg)`; piece.style.animation='fall 1200ms linear forwards'; conf.appendChild(piece); setTimeout(()=>piece.remove(),1600); } }

    rollBtn.addEventListener('click', async ()=>{
      if(!pendingBet) return alert('Ø§Ø¨ØªØ¯Ø§ Ø´Ø±Ø· Ø±Ø§ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡');
      rollBtn.disabled = true;
      animateDice();
      setTimeout(async ()=>{
        const vals = [rand(),rand(),rand()];
        vals.forEach((v,i)=>{ diceEls[i].querySelector('.value').textContent = v; });
        const total = vals.reduce((a,b)=>a+b,0);
        const win = total > 12;
        const stake = pendingBet.amount; pendingBet = null;
        placeBetBtn.disabled = false;
        try{
          const userRef = db.collection('users').doc(currentChatId);
          if(win){
            // award stake*2 (Ù‡Ù…Ø§Ù† Ø·ÙˆØ± Ú©Ù‡ Ø®ÙˆØ§Ø³ØªÙ‡ Ø¨ÙˆØ¯ÛŒÙ… Ø´Ø±Ø· Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ø´ÙˆØ¯)
            await db.runTransaction(async (tx)=>{
              const doc = await tx.get(userRef);
              const data = doc.exists ? doc.data() : { balance:0, lastUpdated: Date.now() };
              await accrueFor(data);
              data.balance = (data.balance||0) + (stake*2);
              data.lastUpdated = Date.now();
              tx.set(userRef, data, { merge:true });
            });
            resultEl.textContent = `ğŸ‰ Ø¨Ø±Ø¯! ØªØ§Ø³â€ŒÙ‡Ø§: ${vals.join(' â€¢ ')} (Ø¬Ù…Ø¹: ${total}) â€” Ø¬Ø§ÛŒØ²Ù‡: ${ (stake*2).toLocaleString() } â› Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`;
            makeConfetti();
          } else {
            // Ø¨Ø§Ø®Øª â€” Ú†ÙˆÙ† Ù…Ø¨Ù„Øº Ù‡Ù†Ú¯Ø§Ù… Ø´Ø±Ø· Ú©Ø³Ø± Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            resultEl.textContent = `ğŸ˜” Ø¨Ø§Ø®Øª â€” ØªØ§Ø³â€ŒÙ‡Ø§: ${vals.join(' â€¢ ')} (Ø¬Ù…Ø¹: ${total}) â€” Ø´Ø±Ø· Ø´Ù…Ø§ Ø­Ø°Ù Ø´Ø¯.`;
          }
        }catch(e){ console.error(e); alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø­Ø³Ø§Ø¨'); }
        await renderAccount();
      }, 800);
    });

    /* ---------- ÛŒÚ©â€ŒØ¨Ø§Ø± Ø§Ø¬Ø±Ø§: Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ localStorage Ùˆ init ---------- */
    (async function init(){
      const last = localStorage.getItem('natcoin_last_chat'); if(last) chatIdInput.value = last;
      if(localStorage.getItem('natcoin_last_chat')){
        currentChatId = localStorage.getItem('natcoin_last_chat');
        // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø­Ø³Ø§Ø¨ â€” Ø§Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú©Ø¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒÙ… ØªØ§ gameScreen Ø¨Ø§Ø² Ø´ÙˆØ¯
        try{ await renderAccount(); }catch(e){}
      }
      // Ù†Ù…Ø§ÛŒØ´ Ù…Ù†Ø§Ø³Ø¨
      if(currentChatId) showLogin(); else showLogin();
    })();

    function showGame(){ loginScreen.style.display='none'; gameScreen.style.display='block'; }
    function showLogin(){ loginScreen.style.display='block'; gameScreen.style.display='none'; placeBetBtn.disabled=false; rollBtn.disabled=true; }

    exportBtn.addEventListener('click', async ()=>{
      if(!currentChatId) return alert('Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´Ùˆ');
      try{
        const u = await getUser(currentChatId); const payload = { chatId: currentChatId, account: u, created: Date.now() };
        const docRef = await db.collection('exports').add({ payload, used:false, created: Date.now() });
        const token = `RSD64:E:${docRef.id}`;
        prompt('ØªÙˆÚ©Ù† ÛŒÚ©â€ŒØ¨Ø§Ø±Ù…ØµØ±Ù Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ â€” Ø¢Ù† Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†:', token);
      }catch(e){ console.error(e); alert('Ø®Ø·Ø§ Ø¯Ø± ØµØ¯ÙˆØ± ØªÙˆÚ©Ù†'); }
    });

    // Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† fall Ø¨Ø±Ø§ÛŒ Ú©Ù†ÙØªÛŒ
    const style = document.createElement('style'); style.textContent = `@keyframes fall{ to{ transform: translateY(100vh) rotate(540deg); opacity:.4 } }`; document.head.appendChild(style);

  </script>
</body>
</html>
