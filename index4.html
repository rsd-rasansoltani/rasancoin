<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mahr coin</title>
  <style>
  :root {
    --bg: #ffffff;          /* پس‌زمینه سفید */
    --card: #f2fef4;        /* کارت سبز خیلی روشن */
    --accent: #1e7d32;      /* سبز اصلی */
    --muted: #555;          /* خاکستری تیره */
    color-scheme: light;
  }

  * {
    box-sizing: border-box;
    font-family: Tahoma, Arial, 'IRANSans Bold', system-ui;
  }

  body {
    margin: 0;
    min-height: 100vh;
    background: linear-gradient(180deg, #e9fdf0 0%, #ffffff 100%);
    color: #1a1a1a;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .wrap {
    width: 100%;
    max-width: 980px;
  }

  header {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 18px;
  }

  h1 {
    font-size: 22px;
    margin: 0;
    color: #1e7d32;
    font-weight: bold;
  }

  .card {
    background: var(--card);
    padding: 18px;
    border-radius: 12px;
    box-shadow: 0 6px 24px rgba(0, 80, 0, 0.1);
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 16px;
  }

  label {
    display: block;
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 6px;
  }

  input,
  button,
  textarea,
  select {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(0, 128, 0, 0.2);
    background: transparent;
    color: inherit;
  }

  .muted {
    color: var(--muted);
    font-size: 13px;
  }

  .right {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .balance {
    font-size: 34px;
    font-weight: 700;
    color: #1e7d32;
  }

  .small {
    font-size: 13px;
    color: var(--muted);
  }

  .row {
    display: flex;
    gap: 10px;
  }

  .btn {
    cursor: pointer;
    padding: 10px 12px;
    border-radius: 10px;
    border: 0;
    background: linear-gradient(90deg, #1e7d32, #4caf50);
    color: #ffffff;
    font-weight: 700;
  }

  .ghost {
    background: transparent;
    border: 1px solid rgba(0, 128, 0, 0.3);
    color: #1e7d32;
  }

  footer {
    margin-top: 12px;
    color: var(--muted);
    font-size: 13px;
  }

  .notice {
    background: #e6f9ec;
    padding: 10px;
    border-radius: 8px;
    color: #1e7d32;
    border: 1px solid #b2dfbc;
  }

  .danger {
    background: #ffefef;
    color: #a94442;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #f5c6cb;
  }

  @media (max-width: 880px) {
    .grid {
      grid-template-columns: 1fr;
    }
    .right {
      order: -1;
    }
  }
</style>

  <!-- Firebase compat scripts (بدون module) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Mahr COIN — SRLP64 &amp; خروجی یک‌بار مصرف</h1>
      <div class="muted">خروجی‌ها اکنون یک‌بار مصرف هستند — پس از استفاده، غیرفعال می‌شوند.</div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>ورود / ثبت‌نام (امنیت: پایه — SRLP64)</h2>
        <p class="muted">راهنما: برای صدور به‌صورت یک‌بار مصرف از دکمهٔ «صدور یک‌بارمصرف» استفاده کن؛ توکن ساخته شده را ارسال کن و گیرنده آن را در این پنل درون‌ریزی کند.</p>

        <div style="margin-top:12px">
          <label>Chat ID که ربات پس از استارت کردن به شما میدهد</label>
          <input id="chatIdInput" placeholder="Chat ID که ربات پس از استارت کردن به شما میدهد" />
        </div>

        <div style="margin-top:10px" class="row">
          <button id="startBtn" class="btn">دریافت کد (تلگرام)</button>
          <button id="loginBtn" class="ghost">اعتبارسنجی کد</button>
        </div>

        <div style="margin-top:12px">
          <label>کدی که دریافت کردید</label>
          <input id="codeInput" placeholder="کد 5 رقمی" />
        </div>

        <div style="margin-top:12px">
          <label>مقدار انتقال (سکه)</label>
          <input id="transferAmount" type="number" min="0" step="1" placeholder="مثال: 1000 — مقداری که می‌خواهی صادر/انتقال بدی" />
        </div>

        <div style="margin-top:12px">
          <label>صدور یک‌بارمصرف (توکن)</label>
          <div class="row">
            <button id="exportTokenBtn" class="ghost">صدور یک‌بارمصرف (توکن)</button>
          </div>
          <textarea id="exportArea" style="margin-top:8px;height:84px;" placeholder="توکن یک‌بارمصرف اینجا نمایش می‌یابد (مثال: SLRP:E:abc123)"></textarea>
          <div class="muted small" style="margin-top:8px">نکته: توکن را فقط یک بار می‌توان استفاده کرد. پس از استفاده، دیگر معتبر نیست.</div>
        </div>

        <div style="margin-top:12px">
          <label>درون‌ریزی (توکن یک‌بارمصرف یا Base64 قدیمی)</label>
          <textarea id="importArea" style="height:88px;" placeholder="توکن (مثلاً SRLP64:E:...) یا Base64 قدیمی را اینجا بچسبان"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="importBase64" class="ghost">درون‌ریزی</button>
          </div>
        </div>

        <div style="margin-top:12px" class="danger">
         هشتار : هر گونه سو استفاده از این برنامه پیگرد قانونی خواهد داشت
        </div>

      </section>

      <aside class="card right">
        <div>
          <div class="muted">حساب فعلی</div>
          <div id="accountBox">
            <div class="balance">—</div>
            <div class="muted small">آخرین بروزرسانی: —</div>
            <div style="margin-top:10px" class="row">
              <button id="collectBtn" class="btn">بروزرسانی موجودی</button>
              <button id="logoutBtn" class="ghost">خروج</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">تنظیمات</div>
          <div style="margin-top:8px" class="small">نرخ: <strong>10 سکه / ساعت</strong></div>
          <div class="small">save : <strong>   screenloop.ir</strong></div>
          <div style="margin-top:8px"><label><input id="autoSend" type="checkbox" checked /> ارسال پیام با ربات</label></div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">راهنما کوتاه</div>
          <ul class="small">
            <li>۱) Chat ID را وارد کن و «دریافت کد» را بزن.</li>
            <li>۲) پیام حاوی کد به Chat ID ارسال می‌شود (در صورت فعال بودن ارسال).</li>
            <li>۳) کد را وارد کن و «اعتبارسنجی» را بزن تا وارد شوی.</li>
            <li>۴) برای صدور امن یک توکن یک‌بارمصرف تولید کن و آن را به گیرنده بده.</li>
            <li>۵) گیرنده توکن را در قسمت درون‌ریزی می‌گذارد و یک‌بار مصرف می‌شود.</li>
          </ul>
        </div>

      </aside>
    </div>

    <footer class="muted">تمامی حقوق این وب سایت مربوط به شرکت اسکرین لوپ است.</footer>
  </div>

<script>
/* ------------------ پنهان‌سازی توکن (همان‌طور که بود) ------------------ */
const XOR_KEY = 'rasan_key_42';

const ENCODED_TOKEN_XOR = 'RVdCUl1sUlJBbw5zMyQaWR8QIxI2FwxRCi1LCCxtDhRAbVBGGA46KBptICIWKA==';

function base64Decode(s){ try{ return atob(s); }catch(e){ return null; } }
function base64Encode(s){ try{ return btoa(s); }catch(e){ return null; } }

function xorString(str, key){
  let out = '';
  for(let i=0;i<str.length;i++){ out += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); }
  return out;
}

function getBotToken(){
  const step1 = base64Decode(ENCODED_TOKEN_XOR);
  if(!step1) return null;
  const token = xorString(step1, XOR_KEY);
  return token;
}

/* ------------------ تنظیم Firebase (جایگزین کن با config پروژه تو اگر فرق داره) ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBiHkCAzkTzUO7weLsKGXc917JNob-dhO4",
  authDomain: "rasancoin.firebaseapp.com",
  projectId: "rasancoin",
  storageBucket: "rasancoin.firebasestorage.app",
  messagingSenderId: "289625483659",
  appId: "1:289625483659:web:b7e170072cf09a7157678e",
  measurementId: "G-KNNM4FF9MS"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

auth.signInAnonymously().catch(e => console.warn('auth error', e));

/* ------------------ منطق NatCoin با Firestore ------------------ */
const RATE_PER_HOUR = 10;

async function getUser(chatId){
  const doc = await db.collection('users').doc(chatId).get();
  return doc.exists ? doc.data() : null;
}
async function setUser(chatId, userObj){
  await db.collection('users').doc(chatId).set(userObj, { merge: true });
}
async function deleteUser(chatId){
  await db.collection('users').doc(chatId).delete();
}

function genCode(){ return Math.floor(10000 + Math.random()*90000).toString() }
function formatDate(ts){ if(!ts) return '—'; const d = new Date(ts); return d.toLocaleString(); }
function accrueFor(user){
  const now = Date.now();
  if(!user.lastUpdated){ user.lastUpdated = now; return; }
  const elapsed = now - user.lastUpdated;
  const coins = elapsed / 3600000 * RATE_PER_HOUR;
  user.balance = (user.balance||0) + coins;
  user.lastUpdated = now;
}

/* ------------------ Export as one-time token ------------------ */
/* createExport(payload) -> returns exportId */
async function createExport(payload){
  const docRef = db.collection('exports').doc(); // auto id
  const docData = { payload, used: false, created: Date.now() };
  await docRef.set(docData);
  return docRef.id;
}

/* atomically claim export (return payload) — returns payload if successful, throws otherwise */
async function claimExportOnce(exportId){
  const docRef = db.collection('exports').doc(exportId);
  return await db.runTransaction(async (tx) => {
    const snap = await tx.get(docRef);
    if(!snap.exists) throw 'export not found';
    const data = snap.data();
    if(data.used) throw 'export already used';
    tx.update(docRef, { used: true, claimedAt: Date.now() });
    return data.payload;
  });
}

/* ------------------ ارسال پیام تلگرام (همان‌طور که بود) ------------------ */
async function sendTelegramMessageHidden(chatId, text){
  const token = getBotToken();
  if(!token) return { ok:false, error:'token decode failed' };
  const url = `https://api.telegram.org/bot${encodeURIComponent(token)}/sendMessage`;
  try{
    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ chat_id: chatId, text }) });
    const data = await res.json();
    return data;
  }catch(err){ return { ok:false, error:err.message } }
}

/* ------------------ Export logic (یک‌بارمصرف) ------------------ */
/* When exporting: decrease balance (if transfer>0), save user, then create one-time export doc and return token */
async function exportAccountOneTime(chatId, transferAmount = 0){
  const u = await getUser(chatId);
  if(!u) throw 'no account';
  const amount = Number(transferAmount) || 0;
  if(amount < 0) throw 'bad amount';
  if(amount > 0){
    if((u.balance||0) < amount) throw 'insufficient balance';
    u.balance = (u.balance||0) - amount;
    u.lastUpdated = Date.now();
    await setUser(chatId, u);
  }
  const transfer = amount>0 ? { amount: amount, from: chatId, ts: Date.now(), id: (Date.now().toString(36) + Math.random().toString(36).slice(2,8)) } : null;
  const payload = { chatId, account: u, transfer };
  // create export doc
  const eid = await createExport(payload);
  return `SRLP64:E:${eid}`;
}

/* ------------------ Import logic: accepts either token 'RSD64:E:<id>' or raw Base64/old JSON */
async function importAccountFromInput(input){
  input = (input||'').trim();
  if(!input) throw 'empty input';
  // token form?
  if(input.startsWith('SRLP64:E:')){
    const eid = input.slice('SRLP64:E:'.length);
    const payload = await claimExportOnce(eid); // atomic claim
    // restore source account
    await setUser(payload.chatId, payload.account);
    // if transfer exists, add to target (currentChatId or prompt)
    if(payload.transfer && payload.transfer.amount){
      let target = currentChatId;
      if(!target || target === payload.chatId){
        target = prompt('برای کدام Chat ID می‌خواهید مبلغ را اضافه کنید؟ (Chat ID یا @username)', '');
        if(!target) return payload.chatId;
      }
      let tuser = await getUser(target);
      if(!tuser) tuser = { balance:0, lastUpdated: Date.now() };
      tuser.balance = (tuser.balance||0) + Number(payload.transfer.amount);
      tuser.lastUpdated = Date.now();
      await setUser(target, tuser);
      return target;
    }
    return payload.chatId;
  } else {
    // try as legacy Base64 JSON
    const raw = base64Decode(input);
    if(!raw) throw 'bad base64';
    const obj = JSON.parse(raw);
    await setUser(obj.chatId, obj.account);
    if(obj.transfer && obj.transfer.amount){
      let target = currentChatId;
      if(!target || target === obj.chatId){
        target = prompt('برای کدام Chat ID می‌خواهید مبلغ را اضافه کنید؟ (Chat ID یا @username)', '');
        if(!target) return obj.chatId;
      }
      let tuser = await getUser(target);
      if(!tuser) tuser = { balance:0, lastUpdated: Date.now() };
      tuser.balance = (tuser.balance||0) + Number(obj.transfer.amount);
      tuser.lastUpdated = Date.now();
      await setUser(target, tuser);
      return target;
    }
    return obj.chatId;
  }
}

/* ------------------ رابط کاربری و توابع اصلی (تماماً async شد) ------------------ */
const chatIdInput = document.getElementById('chatIdInput');
const codeInput = document.getElementById('codeInput');
const startBtn = document.getElementById('startBtn');
const loginBtn = document.getElementById('loginBtn');
const collectBtn = document.getElementById('collectBtn');
const logoutBtn = document.getElementById('logoutBtn');
const exportTokenBtn = document.getElementById('exportTokenBtn');
const exportArea = document.getElementById('exportArea');
const importArea = document.getElementById('importArea');
const importBase64Btn = document.getElementById('importBase64');
const transferAmountInput = document.getElementById('transferAmount');

let currentChatId = null;

async function renderAccount(chatId){
  const box = document.getElementById('accountBox');
  if(!chatId){ box.querySelector('.balance').textContent = '—'; box.querySelector('.muted.small').textContent = 'آخرین بروزرسانی: —'; return; }
  const u = await getUser(chatId);
  if(!u){ box.querySelector('.balance').textContent = '—'; box.querySelector('.muted.small').textContent = 'آخرین بروزرسانی: —'; return; }
  accrueFor(u);
  await setUser(chatId, u);
  box.querySelector('.balance').textContent = Math.floor(u.balance).toLocaleString() + ' ⛁';
  box.querySelector('.muted.small').textContent = 'آخرین بروزرسانی: ' + formatDate(u.lastUpdated);
}

/* UI handlers */
startBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim(); if(!chatId) return alert('Chat ID را وارد کن');
  const code = genCode();
  await db.collection('codes').doc(chatId).set({ code, created: Date.now() });
  if(document.getElementById('autoSend').checked){
    const text = `کد تایید شما: ${code}\n(Screenloop Code)`;
    const resp = await sendTelegramMessageHidden(chatId, text);
    if(resp && resp.ok) alert('کد ارسال شد'); else { console.error(resp); alert('ارسال موفق نبود یا چت ایدی اشتباهه یا vpn روشن نیست'); }
  } else alert('کد ساخته شد (ارسال غیرفعال است)');
});

loginBtn.addEventListener('click', async ()=>{
  const chatId = chatIdInput.value.trim(); const code = codeInput.value.trim(); if(!chatId||!code) return alert('Chat ID و کد لازم است');
  const snap = await db.collection('codes').doc(chatId).get();
  if(!snap.exists) return alert('ابتدا دریافت کد را بزن');
  const e = snap.data();
  if(e.code !== code) return alert('کد نادرست');
  let u = await getUser(chatId);
  if(!u) u = { balance:0, lastUpdated: Date.now() };
  u.lastUpdated = u.lastUpdated || Date.now();
  await setUser(chatId, u);
  await db.collection('codes').doc(chatId).delete();
  currentChatId = chatId; localStorage.setItem('natcoin_last_chat', chatId); alert('ورود موفق'); await renderAccount(currentChatId);
});

collectBtn.addEventListener('click', async ()=>{ if(!currentChatId) return alert('ابتدا وارد شو'); let u = await getUser(currentChatId); if(!u) return alert('حساب یافت نشد'); accrueFor(u); await setUser(currentChatId, u); await renderAccount(currentChatId); });
logoutBtn.addEventListener('click', ()=>{ currentChatId = null; renderAccount(null); alert('خروج انجام شد'); });

exportTokenBtn.addEventListener('click', async ()=>{
  try{
    const chatId = chatIdInput.value.trim(); if(!chatId) return alert('Chat ID را وارد کن');
    const amt = Number(transferAmountInput.value) || 0;
    const token = await exportAccountOneTime(chatId, amt);
    exportArea.value = token;
    alert('توکن یک‌بارمصرف ساخته شد — آن را ذخیره کن و فقط یک‌بار ارسال کن');
    await renderAccount(chatId);
  }catch(e){ alert('خطا: '+e); console.error(e); }
});

importBase64Btn.addEventListener('click', async ()=>{
  try{
    const txt = importArea.value.trim(); if(!txt) return alert('متن را بچسبان');
    const target = await importAccountFromInput(txt);
    alert('درون‌ریزی انجام شد برای: '+target);
    await renderAccount(target);
  }catch(e){ alert('خطا: '+e); console.error(e); }
});

(async function init(){
  const last = localStorage.getItem('natcoin_last_chat'); if(last) chatIdInput.value = last;
  if(localStorage.getItem('natcoin_last_chat')) {
    currentChatId = localStorage.getItem('natcoin_last_chat');
    try{ await renderAccount(currentChatId); }catch(e){}
  } else {
    renderAccount(null);
  }
  chatIdInput.addEventListener('change', ()=> localStorage.setItem('natcoin_last_chat', chatIdInput.value.trim()));
  setInterval(async ()=>{ if(currentChatId) await renderAccount(currentChatId); },30000);
})();
</script>
</body>
</html>



